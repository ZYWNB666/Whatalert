# 系统架构说明

## 总体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          前端 (可选)                              │
│                    React / Vue / Angular                        │
└───────────────────────────┬─────────────────────────────────────┘
                            │ HTTP/REST API
┌───────────────────────────┴─────────────────────────────────────┐
│                      API Gateway (FastAPI)                       │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────────┐   │
│  │  认证    │  告警规则 │  数据源  │  通知    │  静默/审计    │   │
│  │  API     │  API      │  API     │  API     │  API          │   │
│  └──────────┴──────────┴──────────┴──────────┴──────────────┘   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│                        核心业务层                                 │
│  ┌──────────────────┐  ┌─────────────────┐  ┌───────────────┐  │
│  │  规则评估引擎     │  │  告警管理器      │  │  通知服务      │  │
│  │  - 定时评估      │  │  - 状态管理      │  │  - 飞书/钉钉  │  │
│  │  - 查询 Metrics │  │  - 静默检查      │  │  - 企微/邮件  │  │
│  │  - 状态判断      │  │  - 路由分发      │  │  - 模板渲染   │  │
│  └──────────────────┘  └─────────────────┘  └───────────────┘  │
│                                                                  │
│  ┌──────────────────┐  ┌─────────────────┐  ┌───────────────┐  │
│  │  权限管理器       │  │  审计日志        │  │  多租户管理    │  │
│  │  - JWT 认证      │  │  - 操作记录      │  │  - 数据隔离   │  │
│  │  - RBAC 鉴权     │  │  - 追溯查询      │  │  - 配额管理   │  │
│  └──────────────────┘  └─────────────────┘  └───────────────┘  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│                        数据访问层                                 │
│  ┌──────────────────┐  ┌─────────────────┐                      │
│  │  ORM (SQLAlchemy)│  │  Redis Client   │                      │
│  └──────────────────┘  └─────────────────┘                      │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│                          存储层                                   │
│  ┌──────────────────┐  ┌─────────────────┐  ┌───────────────┐  │
│  │  PostgreSQL/MySQL│  │  Redis          │  │  Prometheus   │  │
│  │  - 配置数据      │  │  - 缓存         │  │  - Metrics 数据│  │
│  │  - 告警事件      │  │  - 会话         │  └───────────────┘  │
│  │  - 用户/权限     │  └─────────────────┘                      │
│  └──────────────────┘                                           │
└──────────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. 规则评估引擎 (Evaluator)

**职责:**
- 定时执行 PromQL 查询
- 评估告警条件
- 管理告警状态（pending → firing → resolved）
- 支持持续时间判断（for duration）

**工作流程:**
1. 调度器按规则配置的评估间隔触发评估
2. 查询 Prometheus/VictoriaMetrics 数据源
3. 比较查询结果与阈值
4. 生成告警指纹（基于规则ID和标签）
5. 更新告警状态并推送到告警管理器

### 2. 告警管理器 (AlertManager)

**职责:**
- 管理告警生命周期
- 执行静默规则检查
- 控制通知频率
- 归档历史告警

**核心功能:**
- **静默检查**: 支持基于标签的正则匹配
- **通知节流**: 避免频繁发送通知
- **状态转换**: pending → firing → resolved
- **历史归档**: 已恢复告警移至历史表

### 3. 通知服务 (Notifier)

**职责:**
- 多渠道通知发送
- 标签过滤和路由
- 消息模板渲染
- 通知记录管理

**支持的渠道:**
- **飞书**: 支持高级消息卡片（JSON格式）
- **钉钉**: 支持签名认证
- **企业微信**: 文本/Markdown消息
- **邮件**: HTML 模板

**标签过滤:**
```json
{
  "include_labels": {"severity": ["critical", "warning"]},
  "exclude_labels": {"team": ["test"]}
}
```

### 4. 权限管理 (RBAC)

**模型:**
- **用户 (User)**: 基本账户信息
- **角色 (Role)**: 权限集合
- **权限 (Permission)**: resource:action 格式

**权限示例:**
- `alert_rule:create` - 创建告警规则
- `datasource:read` - 查看数据源
- `notification:update` - 更新通知渠道

### 5. 多租户 (Multi-Tenant)

**特性:**
- 数据完全隔离
- 独立的配额管理
- 租户级别配置
- 跨租户权限控制

**配额示例:**
```json
{
  "max_users": 100,
  "max_alert_rules": 1000,
  "max_datasources": 50
}
```

## 数据模型

### 核心表结构

```sql
-- 租户表
tenant (id, name, code, quota_config, settings)

-- 用户表
user (id, username, email, hashed_password, tenant_id)

-- 角色表
role (id, name, code, tenant_id)

-- 权限表
permission (id, name, code, resource, action)

-- 数据源表
datasource (id, name, type, url, auth_config, tenant_id)

-- 告警规则表
alertrule (id, name, expr, eval_interval, for_duration, severity, route_config, datasource_id, tenant_id)

-- 当前告警表
alertevent (id, fingerprint, rule_id, status, severity, started_at, last_eval_at, labels, tenant_id)

-- 历史告警表
alerteventhistory (id, fingerprint, rule_id, started_at, resolved_at, duration, labels, tenant_id)

-- 静默规则表
silencerule (id, name, matchers, starts_at, ends_at, tenant_id)

-- 通知渠道表
notificationchannel (id, name, type, config, filter_config, tenant_id)

-- 通知记录表
notificationrecord (id, channel_id, alert_fingerprint, status, sent_at, tenant_id)

-- 审计日志表
auditlog (id, action, resource_type, user_id, ip_address, timestamp, tenant_id)
```

## 关键流程

### 告警触发流程

```
1. 规则评估器定时触发
   ↓
2. 查询 Prometheus 数据源
   ↓
3. 评估告警条件
   ↓
4. 生成告警指纹
   ↓
5. 检查是否为新告警
   ├─ 是 → 创建告警事件 (状态: pending)
   └─ 否 → 更新最后评估时间
   ↓
6. 检查持续时间
   ├─ 达到 → 状态转为 firing
   └─ 未达到 → 保持 pending
   ↓
7. 检查静默规则
   ├─ 匹配 → 不发送通知
   └─ 不匹配 → 继续
   ↓
8. 应用告警路由
   ↓
9. 过滤通知渠道标签
   ↓
10. 发送通知
   ↓
11. 记录通知历史
```

### 告警恢复流程

```
1. 规则评估结果为空/不满足条件
   ↓
2. 查找对应指纹的活跃告警
   ↓
3. 更新状态为 resolved
   ↓
4. 发送恢复通知
   ↓
5. 创建历史记录
   ↓
6. 删除当前告警
```

## 性能优化

### 1. 数据库优化
- 多字段索引: `(tenant_id, fingerprint)`
- 查询优化: 使用 `select_in_loading` 预加载关联
- 连接池: 配置合理的池大小

### 2. 缓存策略
- Redis 缓存活跃告警
- 数据源客户端连接池
- 静默规则内存缓存

### 3. 并发处理
- 异步 I/O (asyncio)
- 规则并发评估
- 通知异步发送

## 扩展性

### 水平扩展
- 无状态设计，支持多实例部署
- 通过 Redis 共享会话
- 数据库读写分离

### 功能扩展
- 插件化数据源支持
- 自定义通知渠道
- Webhook 集成

## 安全性

### 认证授权
- JWT Token 认证
- RBAC 权限控制
- 密码 bcrypt 加密

### 数据安全
- 多租户数据隔离
- 敏感信息加密存储
- SQL 注入防护 (ORM)

### 审计
- 完整的操作日志
- IP 地址记录
- 变更追踪

